<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Universal AI</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root{--h:100vh}
body{height:var(--h);overflow:hidden}
#loading{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:white;z-index:999}
.dark #loading{background:#131314;color:white}
.msg-user{background:#f1f5f9;border-radius:18px 18px 0 18px}
.dark .msg-user{background:#2d2d2e}
.typing span{animation:blink 1.4s infinite}
.typing span:nth-child(2){animation-delay:.2s}
.typing span:nth-child(3){animation-delay:.4s}
@keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:1}}
.markdown-body pre{background:#1e1e1e;color:#fff;padding:12px;border-radius:8px;overflow:auto}
</style>
</head>

<body class="bg-white dark:bg-[#131314] text-gray-900 dark:text-gray-100">

<div id="loading">
<div class="text-center">
<div class="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
<p class="mt-3 text-sm">Loading AI...</p>
</div>
</div>

<div id="app" class="hidden h-full flex">

<!-- SIDEBAR -->
<aside class="w-72 bg-gray-50 dark:bg-[#1e1e1f] border-r border-gray-200 dark:border-gray-800 flex flex-col">
<div class="p-4 space-y-2">
<button onclick="newChat()" class="w-full bg-blue-600 text-white p-3 rounded-xl">
<i class="fa fa-plus"></i> New Chat
</button>
<button onclick="exportChat()" class="w-full bg-gray-200 dark:bg-gray-800 p-3 rounded-xl">
Export Chat
</button>
</div>
<div id="chatList" class="flex-1 overflow-y-auto px-2 space-y-1"></div>
<div class="p-3 border-t border-gray-200 dark:border-gray-800 space-y-2">
<button onclick="openSettings()" class="w-full text-left p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-800">
<i class="fa fa-gear"></i> Settings
</button>
<button onclick="toggleTheme()" class="w-full text-left p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-800">
<i id="themeIcon" class="fa fa-moon"></i> Theme
</button>
</div>
</aside>

<!-- MAIN -->
<main class="flex-1 flex flex-col h-full">
<header class="h-14 flex items-center justify-between px-4 border-b border-gray-200 dark:border-gray-800">
<div class="font-semibold">Universal AI</div>
<button onclick="clearChat()" class="text-red-500 text-sm">Clear</button>
</header>

<div id="messages" class="flex-1 overflow-y-auto p-4 space-y-6"></div>

<div class="p-4 border-t border-gray-200 dark:border-gray-800">
<div class="flex gap-2 bg-gray-100 dark:bg-[#1e1e1f] rounded-2xl p-2 items-end">
<textarea id="input" rows="1" class="flex-1 bg-transparent resize-none outline-none p-2 max-h-40"></textarea>
<button id="stopBtn" onclick="stopStream()" class="hidden bg-gray-300 dark:bg-gray-700 w-10 h-10 rounded-xl">
<i class="fa fa-stop"></i>
</button>
<button id="sendBtn" onclick="send()" class="bg-blue-600 text-white w-10 h-10 rounded-xl">
<i class="fa fa-paper-plane"></i>
</button>
</div>
</div>
</main>
</div>

<!-- SETTINGS -->
<div id="settings" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center">
<div class="bg-white dark:bg-[#1e1e1f] p-6 rounded-xl w-80 space-y-4">
<h3 class="font-bold">API Settings</h3>
<input id="key" placeholder="OpenRouter Key" class="w-full p-2 rounded bg-gray-100 dark:bg-gray-800">
<input id="model" value="google/gemini-2.0-flash-lite-preview-02-05:free" class="w-full p-2 rounded bg-gray-100 dark:bg-gray-800">
<div class="flex gap-2">
<button onclick="closeSettings()" class="flex-1 p-2">Cancel</button>
<button onclick="saveSettings()" class="flex-1 p-2 bg-blue-600 text-white rounded">Save</button>
</div>
</div>
</div>

<script>
const state={
key:localStorage.getItem("KEY")||"",
model:localStorage.getItem("MODEL")||"google/gemini-2.0-flash-lite-preview-02-05:free",
chats:[],
active:null,
dark:localStorage.getItem("DARK")==="1"
};

let controller=null;

function init(){
try{state.chats=JSON.parse(localStorage.getItem("CHATS")||"[]")}catch{state.chats=[]}

if(state.dark){
document.documentElement.classList.add("dark");
document.getElementById("themeIcon").className="fa fa-sun";
}

if(state.chats.length===0)newChat();
else{state.active=state.chats[0].id;renderChats();renderMessages()}

document.getElementById("key").value=state.key;
document.getElementById("model").value=state.model;

document.getElementById("loading").style.display="none";
document.getElementById("app").classList.remove("hidden");

const tx=document.getElementById("input");
tx.addEventListener("input",()=>{tx.style.height="auto";tx.style.height=tx.scrollHeight+"px"});
tx.addEventListener("keydown",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();send()}});
}

function save(){localStorage.setItem("CHATS",JSON.stringify(state.chats))}

function newChat(){
const id=Date.now().toString();
state.chats.unshift({id,title:"New Chat",messages:[]});
state.active=id;save();renderChats();renderMessages();
}

function renderChats(){
chatList.innerHTML=state.chats.map(c=>`
<div onclick="switchChat('${c.id}')" class="p-3 rounded cursor-pointer ${state.active===c.id?'bg-gray-200 dark:bg-gray-800':'hover:bg-gray-100 dark:hover:bg-gray-800'} flex justify-between">
<span class="truncate">${c.title}</span>
<i onclick="deleteChat('${c.id}',event)" class="fa fa-trash opacity-50 hover:text-red-500"></i>
</div>`).join("");
}

function deleteChat(id,e){
e.stopPropagation();
state.chats=state.chats.filter(c=>c.id!==id);
if(state.active===id)newChat();
save();renderChats();
}

function switchChat(id){state.active=id;renderChats();renderMessages()}

function renderMessages(){
const chat=state.chats.find(c=>c.id===state.active);
if(!chat||chat.messages.length===0){
messages.innerHTML=`<div class="opacity-40 text-center mt-20">Start conversation</div>`;return;
}
messages.innerHTML=chat.messages.map((m,i)=>`
<div class="flex ${m.role==="user"?"justify-end":"justify-start"}">
<div class="max-w-[80%] p-4 ${m.role==="user"?"msg-user":""}">
<div class="text-xs opacity-50 mb-1 flex justify-between">
<span>${m.role}</span>
${m.role==="assistant"?`<i onclick="copyMsg(${i})" class="fa fa-copy cursor-pointer"></i>`:""}
</div>
<div class="markdown-body">${marked.parse(m.content)}</div>
</div>
</div>`).join("");
messages.scrollTop=messages.scrollHeight;
}

function copyMsg(i){
const chat=state.chats.find(c=>c.id===state.active);
navigator.clipboard.writeText(chat.messages[i].content);
}

function clearChat(){
const c=state.chats.find(x=>x.id===state.active);
if(c){c.messages=[];save();renderMessages()}
}

function exportChat(){
const chat=state.chats.find(c=>c.id===state.active);
if(!chat)return;
const blob=new Blob([JSON.stringify(chat,null,2)],{type:"application/json"});
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="chat.json";
a.click();
}

function openSettings(){settings.classList.remove("hidden")}
function closeSettings(){settings.classList.add("hidden")}

function saveSettings(){
state.key=key.value;
state.model=model.value;
localStorage.setItem("KEY",state.key);
localStorage.setItem("MODEL",state.model);
closeSettings();
}

function toggleTheme(){
state.dark=!state.dark;
document.documentElement.classList.toggle("dark");
localStorage.setItem("DARK",state.dark?"1":"0");
themeIcon.className=state.dark?"fa fa-sun":"fa fa-moon";
}

async function send(){
const text=input.value.trim();
if(!text)return;
if(!state.key){openSettings();return;}

const chat=state.chats.find(c=>c.id===state.active);
if(chat.messages.length===0)chat.title=text.slice(0,30);

chat.messages.push({role:"user",content:text});
input.value="";
renderMessages();

const ai={role:"assistant",content:""};
chat.messages.push(ai);
renderMessages();

sendBtn.classList.add("hidden");
stopBtn.classList.remove("hidden");

controller=new AbortController();

const msgBox=messages.lastElementChild.querySelector(".markdown-body");

try{
const res=await fetch("https://openrouter.ai/api/v1/chat/completions",{
method:"POST",
headers:{
"Authorization":"Bearer "+state.key,
"Content-Type":"application/json"
},
body:JSON.stringify({
model:state.model,
messages:chat.messages.slice(0,-1),
stream:true
}),
signal:controller.signal
});

const reader=res.body.getReader();
const decoder=new TextDecoder();

while(true){
const {done,value}=await reader.read();
if(done)break;
const chunk=decoder.decode(value);
for(const line of chunk.split("\n")){
if(line.startsWith("data: ")){
const data=line.slice(6).trim();
if(data==="[DONE]")break;
try{
const json=JSON.parse(data);
const token=json.choices[0].delta.content||"";
ai.content+=token;
msgBox.innerHTML=marked.parse(ai.content);
messages.scrollTop=messages.scrollHeight;
}catch{}
}
}
}
}catch(e){
ai.content+="\n\n⚠️ stopped or error";
renderMessages();
}

sendBtn.classList.remove("hidden");
stopBtn.classList.add("hidden");

save();
}

function stopStream(){
if(controller)controller.abort();
}

document.addEventListener("DOMContentLoaded",init);
</script>
</body>
</html>
