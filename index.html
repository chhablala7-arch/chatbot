<!DOCTYPE html>
<html lang="hi" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal AI - Stable Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --app-height: 100vh; }
        body { height: var(--app-height); overflow: hidden; background-color: #f9fafb; touch-action: manipulation; }
        .dark body { background-color: #131314; color: #e8eaed; }
        
        /* Loading Screen Style */
        #loading-screen {
            position: fixed; inset: 0; background: white; z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .dark #loading-screen { background: #131314; color: white; }

        /* Mobile Sidebar */
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 50; }
        @media (max-width: 768px) {
            #sidebar { transform: translateX(-100%); position: fixed; }
            #sidebar.active { transform: translateX(0); }
        }

        /* Message Bubbles */
        .msg-user { background: #f0f4f9; border-radius: 1.5rem 1.5rem 0 1.5rem; }
        .dark .msg-user { background: #2d2d2e; }
        .markdown-body pre { background: #1e1e1e; color: #fff; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.5rem 0; }
        
        /* Custom Scrollbar */
        .hide-scroll::-webkit-scrollbar { width: 4px; }
        .hide-scroll::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
    </style>
</head>
<body class="transition-colors duration-200">

    <div id="loading-screen">
        <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 font-medium">Loading Interface...</p>
    </div>

    <div id="app-container" class="invisible flex h-full w-full overflow-hidden">
        <aside id="sidebar" class="w-72 flex-shrink-0 bg-gray-50 dark:bg-[#1e1e1f] border-r border-gray-200 dark:border-gray-800 flex flex-col h-full">
            <div class="p-4">
                <button onclick="createNewChat()" class="w-full flex items-center justify-center gap-2 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 p-3 rounded-xl hover:opacity-80 transition font-semibold">
                    <i class="fa-solid fa-plus"></i> New Chat
                </button>
            </div>
            <div id="chat-list" class="flex-1 overflow-y-auto px-3 space-y-1 hide-scroll"></div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-800">
                <button onclick="openSettings()" class="w-full text-left p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-800 flex items-center gap-3">
                    <i class="fa-solid fa-gear"></i> Settings
                </button>
                <button onclick="toggleDarkMode()" class="w-full text-left p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-800 flex items-center gap-3 mt-1">
                    <i id="theme-icon" class="fa-solid fa-moon"></i> Theme
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 bg-white dark:bg-[#131314] relative h-full">
            <header class="h-14 flex items-center px-4 border-b border-gray-100 dark:border-gray-800 justify-between">
                <button onclick="toggleMenu()" class="md:hidden p-2"><i class="fa-solid fa-bars"></i></button>
                <div class="text-sm font-bold tracking-tight opacity-70">GEMINI CLONE v2</div>
                <button onclick="clearCurrentChat()" class="text-xs text-red-500 hover:underline">Clear Chat</button>
            </header>

            <div id="chat-window" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 pb-40 hide-scroll">
                </div>

            <div class="absolute bottom-0 left-0 w-full p-4 bg-gradient-to-t from-white dark:from-[#131314] via-white dark:via-[#131314]">
                <div class="max-w-3xl mx-auto flex items-end gap-2 bg-gray-100 dark:bg-[#1e1e1f] p-2 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700">
                    <textarea id="main-input" rows="1" class="flex-1 bg-transparent border-none focus:ring-0 p-2 max-h-40 resize-none overflow-y-auto" placeholder="Type your message..."></textarea>
                    <button id="send-btn" onclick="sendMessage()" class="bg-blue-600 text-white w-10 h-10 rounded-xl flex items-center justify-center hover:bg-blue-700 disabled:opacity-50">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/60 hidden z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-[#1e1e1f] w-full max-w-md rounded-2xl p-6 shadow-2xl">
            <h3 class="text-xl font-bold mb-4">API Configuration</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">OpenRouter API Key</label>
                    <input type="password" id="key-input" class="w-full mt-1 p-3 rounded-xl bg-gray-100 dark:bg-gray-800 border-none outline-none focus:ring-2 ring-blue-500">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Model Selection</label>
                    <input type="text" id="model-input" class="w-full mt-1 p-3 rounded-xl bg-gray-100 dark:bg-gray-800 border-none outline-none" value="google/gemini-2.0-flash-lite-preview-02-05:free">
                </div>
            </div>
            <div class="flex gap-2 mt-8">
                <button onclick="closeSettings()" class="flex-1 p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 font-medium">Cancel</button>
                <button onclick="saveSettings()" class="flex-1 p-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-500/30">Save Settings</button>
            </div>
        </div>
    </div>

    <script>
        // -- Error Handling & State --
        const appState = {
            apiKey: localStorage.getItem('OR_KEY') || '',
            model: localStorage.getItem('OR_MODEL') || 'google/gemini-2.0-flash-lite-preview-02-05:free',
            chats: [],
            activeId: null,
            isDark: localStorage.getItem('THEME') === 'dark'
        };

        // -- Initialization --
        function init() {
            try {
                // Load chats with safety check
                const saved = localStorage.getItem('CHATS_V2');
                appState.chats = saved ? JSON.parse(saved) : [];
                
                // Theme set
                if (appState.isDark) {
                    document.documentElement.classList.add('dark');
                    document.getElementById('theme-icon').className = 'fa-solid fa-sun';
                }

                // Initial UI rendering
                if (appState.chats.length === 0) {
                    createNewChat();
                } else {
                    appState.activeId = appState.chats[0].id;
                    renderSidebar();
                    renderMessages();
                }

                // Mobile height fix
                const fixHeight = () => document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
                window.addEventListener('resize', fixHeight);
                fixHeight();

                // Reveal app
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('invisible');

                // Textarea auto-resize
                const tx = document.getElementById('main-input');
                tx.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });

                tx.addEventListener('keydown', (e) => {
                    if(e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });

            } catch (err) {
                console.error("Initialization failed:", err);
                alert("App loading error. Clearing cache...");
                localStorage.clear();
                location.reload();
            }
        }

        // -- Actions --
        function toggleMenu() { document.getElementById('sidebar').classList.toggle('active'); }
        function openSettings() { 
            document.getElementById('key-input').value = appState.apiKey;
            document.getElementById('settings-modal').classList.remove('hidden'); 
        }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
        
        function saveSettings() {
            appState.apiKey = document.getElementById('key-input').value;
            appState.model = document.getElementById('model-input').value;
            localStorage.setItem('OR_KEY', appState.apiKey);
            localStorage.setItem('OR_MODEL', appState.model);
            closeSettings();
        }

        function toggleDarkMode() {
            appState.isDark = !appState.isDark;
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('THEME', appState.isDark ? 'dark' : 'light');
            document.getElementById('theme-icon').className = appState.isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        }

        function createNewChat() {
            const id = Date.now().toString();
            appState.chats.unshift({ id, title: 'New Chat', messages: [] });
            appState.activeId = id;
            saveAndRefresh();
            if(window.innerWidth < 768) toggleMenu();
        }

        function switchChat(id) {
            appState.activeId = id;
            renderMessages();
            renderSidebar();
            if(window.innerWidth < 768) toggleMenu();
        }

        function saveAndRefresh() {
            localStorage.setItem('CHATS_V2', JSON.stringify(appState.chats));
            renderSidebar();
        }

        function renderSidebar() {
            const list = document.getElementById('chat-list');
            list.innerHTML = appState.chats.map(chat => `
                <div onclick="switchChat('${chat.id}')" class="group flex items-center justify-between p-3 rounded-xl cursor-pointer transition ${appState.activeId === chat.id ? 'bg-gray-200 dark:bg-gray-800' : 'hover:bg-gray-100 dark:hover:bg-gray-800/50'}">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <i class="fa-regular fa-comment-dots text-sm opacity-50"></i>
                        <span class="truncate text-sm font-medium">${chat.title}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderMessages() {
            const win = document.getElementById('chat-window');
            const chat = appState.chats.find(c => c.id === appState.activeId);
            if (!chat) return;

            if (chat.messages.length === 0) {
                win.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center opacity-20 text-center">
                        <i class="fa-solid fa-bolt-lightning text-6xl mb-4"></i>
                        <h2 class="text-2xl font-bold">Start a new conversation</h2>
                    </div>
                `;
                return;
            }

            win.innerHTML = chat.messages.map(m => `
                <div class="flex ${m.role === 'user' ? 'justify-end' : 'justify-start'} animate-in fade-in duration-300">
                    <div class="p-4 max-w-[85%] ${m.role === 'user' ? 'msg-user' : ''}">
                        <div class="text-[10px] font-bold uppercase mb-1 opacity-40 tracking-widest">
                            ${m.role === 'user' ? 'You' : 'AI Assistant'}
                        </div>
                        <div class="markdown-body text-sm leading-relaxed">${marked.parse(m.content)}</div>
                    </div>
                </div>
            `).join('');
            win.scrollTo({ top: win.scrollHeight, behavior: 'smooth' });
        }

        async function sendMessage() {
            const input = document.getElementById('main-input');
            const btn = document.getElementById('send-btn');
            const text = input.value.trim();

            if (!text || btn.disabled) return;
            if (!appState.apiKey) { openSettings(); return; }

            const chat = appState.chats.find(c => c.id === appState.activeId);
            if (chat.messages.length === 0) chat.title = text.slice(0, 25) + '...';

            chat.messages.push({ role: 'user', content: text });
            input.value = '';
            input.style.height = 'auto';
            renderMessages();

            // AI Response Placeholder
            btn.disabled = true;
            const aiMsg = { role: 'assistant', content: '' };
            chat.messages.push(aiMsg);
            renderMessages();

            const win = document.getElementById('chat-window');
            const lastMsgDiv = win.lastElementChild.querySelector('.markdown-body');

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${appState.apiKey}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: appState.model,
                        messages: chat.messages.slice(0, -1),
                        stream: true
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.slice(6);
                            if (dataStr.trim() === '[DONE]') break;
                            try {
                                const json = JSON.parse(dataStr);
                                const delta = json.choices[0].delta.content || '';
                                aiMsg.content += delta;
                                lastMsgDiv.innerHTML = marked.parse(aiMsg.content);
                                win.scrollTop = win.scrollHeight;
                            } catch (e) {}
                        }
                    }
                }
            } catch (err) {
                aiMsg.content = "⚠️ Connection Error. Please check your API key.";
                renderMessages();
            } finally {
                btn.disabled = false;
                saveAndRefresh();
            }
        }

        function clearCurrentChat() {
            const chat = appState.chats.find(c => c.id === appState.activeId);
            if (chat) {
                chat.messages = [];
                saveAndRefresh();
                renderMessages();
            }
        }

        // Start App
        window.onload = init;
    </script>
</body>
</html>
